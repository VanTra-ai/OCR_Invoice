<!-- imglab/tags/images-slider.tag.html -->
<images-slider class="form-inline">
  <style>
    input[type="file"] {
      display: none;
    }
    .photolist-wrapper {
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      width: calc(100% - 60px);
      height: 90px;
    }
    .photolist-wrapper::-webkit-scrollbar {
      height: 6px;
    }
    .photolist-wrapper::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    .photolist img {
      cursor: pointer;
      border: 2px solid transparent;
      margin-right: 4px;
      height: 80px;
      display: inline-block;
    }
    .photolist img:hover {
      opacity: 0.8;
    }
    .active-thumb {
      border-color: #007bff !important;
    }
  </style>

  <div style="width: 50px; text-align: center; padding: 10px">
    <label class="btn-bs-file" title="Upload Images">
      <i class="icon-picture" style="font-size: 1.5em"></i>
      <input
        id="browseImages"
        type="file"
        class="filebutton"
        accept="image/*"
        onchange="{readImageFiles}"
        multiple
      />
    </label>
  </div>

  <div class="photolist-wrapper">
    <div id="photolist" class="photolist">
      <img id={"thumbnail_" + index} each={thumbnail, index in thumbnails}
      src={thumbnail.src} title={thumbnail.name} onclick={loadIntoWorkArea} />
    </div>
  </div>

  <script>
    var tag = this;
    tag.thumbnails = [];

    // --- XỬ LÝ FILE ---
    tag.readImageFiles = function (e) {
      var input = e.srcElement || e.target;
      if (input.files && input.files[0]) {
        for (var i = 0; i < input.files.length; i++) {
          var reader = new FileReader();
          reader.onload = (function (f) {
            return function (e) {
              var imgData = { name: f.name, src: e.target.result };

              var img = new Image();
              img.onload = function () {
                imgData.size = {
                  width: this.width,
                  height: this.height,
                  scaledWidth: this.width,
                  scaledHeight: this.height,
                  imageScale: 1,
                };
                if (typeof addImgToStore === "function") {
                  addImgToStore(imgData.name, imgData.size);
                }

                tag.thumbnails.push(imgData);
                tag.update();

                // Auto load ảnh đầu tiên
                if (tag.thumbnails.length === 1) {
                  setTimeout(function () {
                    tag.loadIntoWorkArea({
                      item: imgData,
                      target: document.getElementById("thumbnail_0"),
                    });
                  }, 100);
                }
              };
              img.src = e.target.result;
            };
          })(input.files[i]);
          reader.readAsDataURL(input.files[i]);
        }
      }
      input.value = null;
    };

    // --- CHỌN ẢNH ĐỂ VẼ ---
    tag.loadIntoWorkArea = function (e) {
      // === SỬA LỖI LOGIC TẠI ĐÂY ===
      // Kiểm tra: Nếu e.item có thuộc tính thumbnail (do click trong vòng lặp) thì lấy nó
      // Nếu không (do gọi thủ công lúc upload), thì lấy chính e.item
      var selectedData = e.item && e.item.thumbnail ? e.item.thumbnail : e.item;

      if (!selectedData) {
        console.error("Không lấy được dữ liệu ảnh từ sự kiện click", e);
        return;
      }

      // 1. Cập nhật biến toàn cục
      window.imgSelected = selectedData;

      // 2. Highlight ảnh
      var allThumbs = document.querySelectorAll(".photolist img");
      for (var i = 0; i < allThumbs.length; i++) {
        allThumbs[i].classList.remove("active-thumb");
      }
      if (e.target) e.target.classList.add("active-thumb");

      // 3. Gọi Workarea vẽ lại (Quan trọng: Phải dùng riot.mount để kích hoạt initWorkArea bên kia)
      console.log("Loading image:", selectedData.name);
      riot.mount("workarea", { img: selectedData });
    };
  </script>
</images-slider>
