<!-- imglab/tags/attributes-list.tag.html -->
<attributes-list>
  <style>
    #attributes-list-container {
      padding: 10px;
      background-color: #f4f4f4;
      height: 100%;
    }
    .attribute-card {
      background: white;
      border: 1px solid #ccc;
      border-left: 5px solid #ccc;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: relative;
    }
    .field-label {
      font-size: 11px;
      font-weight: bold;
      color: #666;
      margin-bottom: 4px;
      display: block;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 14px;
    }
    input[type="text"]:focus {
      border-color: #007bff;
      outline: none;
    }
    .input-label {
      font-weight: 600;
      color: #0056b3;
    }
    .header-section {
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
      padding-left: 5px;
    }
  </style>

  <div id="attributes-list-container">
    <div class="header-section">OCR Data Fields</div>

    <div
      class="attribute-card"
      each="{ attribute, index in attributes }"
      id="card_{index}"
    >
      <div>
        <span class="field-label">Category / Label (Loại nhãn)</span>
        <input
          type="text"
          class="input-label attr-label-input"
          value="{ attribute.label }"
          oninput="{updateAttributeName}"
          onchange="{updateAttributeName}"
          placeholder="Click to select label..."
        />
      </div>

      <div>
        <span class="field-label">Content (Nội dung)</span>
        <input
          type="text"
          class="input-value attr-value-input"
          value="{ attribute.value }"
          oninput="{updateAttributeValue}"
          onchange="{updateAttributeValue}"
          placeholder="OCR Text..."
        />
      </div>
    </div>
  </div>

  <script>
    var tag = this;
    tag.attributes = opts.attributes || [];
    tag.shapeId = opts.shapeId; // Nhận ID hình từ cha

    this.on("mount", function () {
      initAutocomplete();
      // Cập nhật màu ngay khi mở panel
      if (tag.attributes.length > 0 && tag.attributes[0].label) {
        updateColor(tag.attributes[0].label);
      }
      // Auto focus
      setTimeout(() => {
        var inputs = tag.root.querySelectorAll(".attr-value-input");
        if (inputs.length > 0) inputs[0].focus();
      }, 100);
    });

    function updateColor(label) {
      var color =
        typeof labelColors !== "undefined" && labelColors[label]
          ? labelColors[label]
          : "rgb(192, 192, 192)";

      // 1. Cập nhật thanh màu bên trái thẻ Card
      $(tag.root).find(".attribute-card").css("border-left-color", color);

      // 2. Gửi sự kiện sang Workarea
      // --- SỬA QUAN TRỌNG: Dùng sự kiện 'labelChanged' để Workarea vừa đổi màu vừa lưu dữ liệu ---
      if (tag.shapeId && typeof eventBus !== "undefined") {
        eventBus.trigger("labelChanged", tag.shapeId, label, color);
      }
    }

    function initAutocomplete() {
      if (typeof $ !== "undefined" && $.fn.autocomplete) {
        $(tag.root)
          .find(".attr-label-input")
          .each(function (i, el) {
            if (!$(el).data("ui-autocomplete")) {
              $(el)
                .autocomplete({
                  source:
                    typeof suggestedCategories !== "undefined"
                      ? suggestedCategories
                      : [],
                  minLength: 0,
                  select: function (event, ui) {
                    var domIndex = $(tag.root)
                      .find(".attr-label-input")
                      .index(el);
                    if (tag.attributes[domIndex]) {
                      tag.attributes[domIndex].label = ui.item.value;
                      updateColor(ui.item.value);
                      tag.update();
                    }
                  },
                })
                .focus(function () {
                  $(this).autocomplete("search", "");
                });
            }
          });
      }
    }

    this.updateAttributeName = function (e) {
      var val = e.target.value;
      e.item.attribute.label = val;
      updateColor(val);
    };

    this.updateAttributeValue = function (e) {
      e.item.attribute.value = e.target.value;
    };
  </script>
</attributes-list>
